<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root { --primary: #8338EC; --secondary: #5E52F6; --background: #121212; --card-bg: #1E1E1E; --text-primary: #EAEAEA; --text-secondary: #A0A0A0; --border-color: rgba(255,255,255,0.1); --green: #05F29B; --yellow: #FFC700; --red: #FF3B30; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background-color: var(--background); color: var(--text-primary); }
        .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 260px; background: #181818; border-right: 1px solid var(--border-color); transform: translateX(-100%); transition: transform 0.3s; z-index: 1000; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header h2 { margin: 0; padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color); }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; border-bottom: 1px solid var(--border-color); transition: all 0.2s; }
        .sidebar-nav a:hover, .sidebar-nav a.active-link { background-color: var(--primary); color: white; }
        .main-content { transition: margin-left 0.3s; padding: 20px; }
        .header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        #menu-toggle { font-size: 24px; cursor: pointer; }
        .view { display: none; } .view.active { display: block; }
        .card { background-color: var(--card-bg); border-radius: 16px; padding: 25px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid var(--border-color); color: white; border-radius: 8px; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--red); color: white; }
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .table button { margin-right: 5px; padding: 5px 10px; font-size: 12px; cursor: pointer; }
        .table button.btn-sm { padding: 3px 8px; font-size: 10px; }
        @media (min-width: 992px) { .sidebar { transform: translateX(0); } .main-content { margin-left: 260px; } #menu-toggle { display: none; } }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div id="auth-layer" style="position:fixed;top:0;left:0;width:100%;height:100%;background:var(--background);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:var(--card-bg);padding:40px;border-radius:16px;text-align:center;width:320px;">
            <i class="fas fa-lock" style="font-size:28px;color:var(--primary);margin-bottom:15px;"></i><h3>Admin Panel</h3>
            <input type="password" id="admin-password" placeholder="******" style="width:100%;padding:12px;background:#2a2a2a;color:white;border-radius:8px;margin-top:20px;text-align:center;border:1px solid var(--border-color);">
            <button onclick="checkPassword()" class="btn btn-primary" style="width:100%;margin-top:20px;">Login</button>
        </div>
    </div>
    <div id="app-wrapper" style="display:none;">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header"><h2 id="bot-username-display">Admin</h2></div>
            <nav class="sidebar-nav">
                <a href="#" onclick="showView('dashboard', this)"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#" onclick="showView('users', this)"><i class="fas fa-users"></i> User Management</a>
                <a href="#" onclick="showView('withdrawals', this)"><i class="fas fa-wallet"></i> Withdrawals</a>
                <a href="#" onclick="showView('broadcast', this)"><i class="fas fa-bullhorn"></i> Broadcast</a>
                <a href="#" onclick="showView('settings', this)"><i class="fas fa-cogs"></i> Settings</a>
            </nav>
        </div>
        <div class="main-content">
            <header class="header"><i class="fas fa-bars" id="menu-toggle"></i><h1 id="header-title"></h1></header>
            <div id="dashboard-view" class="view"></div>
            <div id="users-view" class="view"></div>
            <div id="withdrawals-view" class="view"></div>
            <div id="broadcast-view" class="view"></div>
            <div id="settings-view" class="view"></div>
        </div>
    </div>
    
    <!-- IMPORTANT: Ensure 'language.js' file exists in the same directory -->
    <!-- If it doesn't, you'll need to create it or embed its content here -->
    <script src="language.js"></script>

    <script>
        // --- Embedded config.js Content ---
        // Telegram Bot Configuration
        const BOT_USERNAME = '@Ads_To_Money25bot'; // আপনার নতুন টেলিগ্রাম বটের ইউজারনেম
        const BOT_NAME = 'Ads to Money';          // আপনার নতুন বটের প্রদর্শিত নাম (ঐচ্ছিক)

        // Firebase Configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBfQBxUY9ftvzXTJykMf4Z_mEvIgaQ0RyI",
            authDomain: "earing-technology.firebaseapp.com",
            databaseURL: "https://earing-technology-default-rtdb.firebaseio.com",
            projectId: "earing-technology",
            storageBucket: "earing-technology.firebasestorage.app",
            messagingSenderId: "567390086459",
            appId: "1:567390086459:web:a717e290a37a623be9431e",
            measurementId: "G-C8CK3P3LQL"
        };

        // Admin Panel Configuration
        const ADMIN_PASSWORD = '@@@@@'; // আপনার দেওয়া পাসওয়ার্ড

        // Ad Zones Configuration (Monetage SDK এর জন্য)
        const AD_ZONES = {
            interstitial: '9698971', // রিওয়ার্ডেড ইন্টারস্টিশিয়ালের জন্য
            popup: '9698971'         // রিওয়ার্ডেড পপআপের জন্য (যদি একই জোন হয়)
        };

        // Ad Limits Configuration
        const AD_LIMITS = {
            interstitial: 5, // প্রতিদিন রিওয়ার্ডেড ইন্টারস্টিশিয়াল অ্যাডের সর্বোচ্চ সংখ্যা
            popup: 3         // প্রতিদিন রিওয়ার্ডেড পপআপ অ্যাডের সর্বোচ্চ সংখ্যা
        };

        // Engagement Features Configuration
        const ENGAGEMENT_FEATURES = {
            daily_bonus: {
                enabled: true,
                reward: 0.05 // প্রতিদিনের বোনাস দাবি করার জন্য রিওয়ার্ড
            },
            referral_system: {
                enabled: true,
                reward_per_referral: 0.10 // প্রতি সফল রেফারেলের জন্য রিওয়ার্ড
            }
        };

        // Withdrawal Settings
        const WITHDRAWAL_SETTINGS = {
            fee_percentage: 5 // উইথড্রয়াল ফি শতাংশ
        };
        // --- End of Embedded config.js Content ---

        let db;

        function checkPassword(){ 
            if (typeof ADMIN_PASSWORD === 'undefined' || typeof FIREBASE_CONFIG === 'undefined') {
                alert("Configuration error. Please check config.");
                return;
            }

            if(document.getElementById('admin-password').value === ADMIN_PASSWORD) { 
                document.getElementById('auth-layer').style.display = 'none'; 
                document.getElementById('app-wrapper').style.display = 'block'; 
                initializeApp(); 
            } else { 
                alert("Incorrect Password!"); 
            }
        }

        function initializeApp(){ 
            firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.database();
            setupUI(); 
            loadData(); 
        }

        function setupUI(){
            if (typeof BOT_USERNAME !== 'undefined') {
                document.getElementById('bot-username-display').innerText = BOT_USERNAME;
            }
            document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));
            
            document.getElementById('dashboard-view').innerHTML = `<div class="card" id="stats-card">Loading stats...</div>`;
            document.getElementById('users-view').innerHTML = `
                <div class="card">
                    <h3>All Users</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Balance (USD)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr><td colspan="5" style="text-align:center;">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            document.getElementById('withdrawals-view').innerHTML = `
                <div class="card">
                    <h3>Withdrawal Requests</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Fee</th>
                                    <th>Payable</th>
                                    <th>Address</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdraw-requests-table">
                                <tr><td colspan="8" style="text-align:center;">Loading requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            document.getElementById('broadcast-view').innerHTML = `
                <div class="card">
                    <h3>Send Broadcast Message</h3>
                    <p>This message will appear in the marquee for all users.</p>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="marquee-text" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveBroadcast()">Send Message</button>
                </div>`;
            
            document.getElementById('settings-view').innerHTML = `
                <div class="card">
                    <h3>Read-Only Settings (Edit in config.js)</h3>
                    <p>These core settings are managed in the config.js file for better security and control.</p>
                    <div class="form-group">
                        <label>Bot Username</label>
                        <input type="text" value="${BOT_USERNAME || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Ad Zone (Interstitial)</label>
                        <input type="text" value="${AD_ZONES.interstitial || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Ad Zone (Popup)</label>
                        <input type="text" value="${AD_ZONES.popup || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Daily Interstitial Limit</label>
                        <input type="text" value="${AD_LIMITS.interstitial || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Daily Popup Limit</label>
                        <input type="text" value="${AD_LIMITS.popup || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Withdrawal Fee</label>
                        <input type="text" value="${WITHDRAWAL_SETTINGS.fee_percentage || 'N/A'}%" readonly>
                    </div>
                    <div class="form-group">
                        <label>Referral Reward</label>
                        <input type="text" value="$${ENGAGEMENT_FEATURES.referral_system.reward_per_referral || 'N/A'}" readonly>
                    </div>
                </div>`;
            
            showView('dashboard', document.querySelector('.sidebar-nav a'));
        }

        function showView(viewName, link){ 
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); 
            document.getElementById(`${viewName}-view`).classList.add('active'); 
            if (link && link.innerText) {
                document.getElementById('header-title').innerText = link.innerText; 
            }
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active-link')); 
            if (link) link.classList.add('active-link');
            if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
        }

        function loadData(){
            db.ref('users').on('value', u_snap => {
                const users = u_snap.val() || {};
                const numUsers = u_snap.numChildren();
                
                db.ref('withdrawal_requests').on('value', w_snap => {
                    const withdrawals = w_snap.val() || {};
                    const pendingWithdrawals = Object.values(withdrawals).filter(w => w.status === 'pending').length;
                    
                    document.getElementById('stats-card').innerHTML = `
                        <h3>Stats</h3>
                        <p>Total Users: ${numUsers}</p>
                        <p>Pending Withdrawals: ${pendingWithdrawals}</p>
                    `;
                });
                
                const user_tbody = document.getElementById('users-table'); 
                user_tbody.innerHTML = '';
                if (numUsers === 0) {
                    user_tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No users found.</td></tr>';
                } else {
                    Object.entries(users).forEach(([userId, user]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${userId}</td>
                            <td>${user.username || '-'}</td>
                            <td>$${(user.balanceUSD || 0).toFixed(4)}</td>
                            <td>${user.banned ? '<span style="color:var(--red);">Banned</span>' : '<span style="color:var(--green);">Active</span>'}</td>
                            <td>
                                <button class="btn btn-sm ${user.banned ? 'btn-primary' : 'btn-danger'}" onclick="${user.banned ? `unbanUser('${userId}')` : `banUser('${userId}')`}">
                                    ${user.banned ? 'Unban' : 'Ban'}
                                </button>
                            </td>
                        `;
                        user_tbody.prepend(row);
                    });
                }
            });

            db.ref('withdrawal_requests').limitToLast(50).on('value', snap => {
                const w_tbody = document.getElementById('withdraw-requests-table'); 
                w_tbody.innerHTML = '';
                const requests = snap.val() || {};
                const requestEntries = Object.entries(requests);

                if (requestEntries.length === 0) {
                    w_tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No withdrawal requests found.</td></tr>';
                } else {
                    requestEntries.forEach(([key, req]) => {
                        const fee = (req.amount * WITHDRAWAL_SETTINGS.fee_percentage) / 100; 
                        const payable = req.amount - fee;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${req.username || req.userId}</td>
                            <td>$${req.amount.toFixed(4)}</td>
                            <td>$${fee.toFixed(4)}</td>
                            <td>$${payable.toFixed(4)}</td>
                            <td>${req.walletAddress}</td>
                            <td>${req.paymentMethod}</td>
                            <td>${req.status}</td>
                            <td>
                                ${req.status === 'pending' ? 
                                    `<button onclick="handleRequest('${key}','approved', ${req.amount}, '${req.userId}')">Approve</button>
                                     <button onclick="handleRequest('${key}','rejected', ${req.amount}, '${req.userId}')">Reject</button>`
                                : ''}
                            </td>
                        `;
                        w_tbody.prepend(row);
                    });
                }
            });

            db.ref('config/marqueeText').on('value', snap => { 
                document.getElementById('marquee-text').value = snap.val() || ''; 
            });
        }

        function saveBroadcast(){ 
            const message = document.getElementById('marquee-text').value.trim();
            db.ref('config/marqueeText').set(message)
                .then(() => alert('Broadcast message updated!'))
                .catch(e => {
                    console.error("Error saving broadcast message:", e);
                    alert('Failed to update broadcast message.');
                });
        }

        function handleRequest(key, status, amount, userId){
            let confirmMessage = '';
            if(status === 'rejected'){ 
                confirmMessage = 'Reject and refund the amount to the user?';
            } else if (status === 'approved') {
                confirmMessage = 'Approve this withdrawal request?';
            }

            if(!confirm(confirmMessage)) {
                return;
            }

            if(status === 'rejected'){ 
                db.ref(`users/${userId}/balanceUSD`).transaction(b => (b === null ? 0 : b) + amount)
                    .then(() => {
                        db.ref(`withdrawal_requests/${key}`).update({status});
                        alert('Request rejected and balance refunded.');
                    })
                    .catch(e => {
                        console.error("Error refunding balance on rejection:", e);
                        alert('Failed to refund balance. Please handle manually.');
                    });
            } else if (status === 'approved') {
                db.ref(`withdrawal_requests/${key}`).update({status})
                    .then(() => alert('Withdrawal request approved. Please process payment manually.'))
                    .catch(e => {
                        console.error("Error approving withdrawal request:", e);
                        alert('Failed to update request status.');
                    });
            }
        }

        function banUser(userId){ 
            if(confirm(`Ban user ${userId}? This action cannot be undone without manual intervention.`)){ 
                db.ref(`users/${userId}/banned`).set(true)
                    .then(() => alert(`User ${userId} has been banned.`))
                    .catch(e => {
                        console.error("Error banning user:", e);
                        alert('Failed to ban user.');
                    });
            }
        }

        function unbanUser(userId) {
            if(confirm(`Unban user ${userId}?`)){ 
                db.ref(`users/${userId}/banned`).set(false)
                    .then(() => alert(`User ${userId} has been unbanned.`))
                    .catch(e => {
                        console.error("Error unbanning user:", e);
                        alert('Failed to unban user.');
                    });
            }
        }
    </script>
</body>
</html>